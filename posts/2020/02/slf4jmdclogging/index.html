<!doctype html><html lang><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Slf4j Mapped Diagnostic Context (MDC) 를 이용한 사용자 요청 추적 | 개발자 지호</title><link rel=stylesheet href=/css/eureka.min.css><script defer src=/js/eureka.min.js></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload="this.onload=null,this.rel='stylesheet'"><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/styles/solarized-light.min.css media=print onload="this.media='all',this.onload=null" crossorigin><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/highlight.min.js crossorigin></script><script defer src=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/js/all.min.js integrity="sha256-uNYoXefWRqv+PsIF/OflNmwtKM4lStn9yrz2gVl6ymo=" crossorigin></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X media=print onload="this.media='all',this.onload=null" crossorigin><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><link rel=preconnect href=https://www.google-analytics.com crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=UA-151941743-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-151941743-1')</script><link rel=icon type=image/png sizes=32x32 href=/images/jiho_huafb81788da7ee21cf8234b9b792a3f72_3334808_32x32_fill_box_center_2.png><link rel=apple-touch-icon sizes=180x180 href=/images/jiho_huafb81788da7ee21cf8234b9b792a3f72_3334808_180x180_fill_box_center_2.png><meta name=description content="Slf4j Mapped Diagnostic Context (MDC) 를 이용한 사용자 요청 추적"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"/posts/"},{"@type":"ListItem","position":2,"name":"Slf4j Mapped Diagnostic Context (MDC) 를 이용한 사용자 요청 추적","item":"/posts/2020/02/slf4jmdclogging/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/2020/02/slf4jmdclogging/"},"headline":"Slf4j Mapped Diagnostic Context (MDC) 를 이용한 사용자 요청 추적 | 개발자 지호","datePublished":"2020-02-22T00:00:00+09:00","dateModified":"2020-02-22T00:00:00+09:00","wordCount":930,"author":{"@type":"Person","name":["jiho"]},"publisher":{"@type":"Person","name":"Jiho. Sung","logo":{"@type":"ImageObject","url":"/images/jiho.png"}},"description":"Slf4j Mapped Diagnostic Context (MDC) 를 이용한 사용자 요청 추적"}</script><meta property="og:title" content="Slf4j Mapped Diagnostic Context (MDC) 를 이용한 사용자 요청 추적 | 개발자 지호"><meta property="og:type" content="article"><meta property="og:image" content="/images/jiho.png"><meta property="og:url" content="/posts/2020/02/slf4jmdclogging/"><meta property="og:description" content="Slf4j Mapped Diagnostic Context (MDC) 를 이용한 사용자 요청 추적"><meta property="og:site_name" content="개발자 지호"><meta property="article:published_time" content="2020-02-22T00:00:00+09:00"><meta property="article:modified_time" content="2020-02-22T00:00:00+09:00"><meta property="article:section" content="posts"><meta property="article:tag" content="mdc"><meta property="og:see_also" content="/posts/2021/03/zookeeperpractice/"><meta property="og:see_also" content="/posts/2020/05/distributedtracing/"><meta property="og:see_also" content="/posts/2020/03/nginxresourcelogdisable/"><meta property="og:see_also" content="/posts/2020/01/rsocket/"><body class="flex flex-col min-h-screen"><header class="fixed flex items-center w-full min-h-16 pl-scrollbar z-50 bg-secondary-bg shadow-sm"><div class="w-full max-w-screen-xl mx-auto"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=='Auto'||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName('html')[0].classList.add('dark')</script><nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0"><a href=/ class="mr-6 text-primary-text text-xl font-bold">개발자 지호</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i></button><div id=target class="hidden block md:flex md:flex-grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20"><div class="md:flex md:h-16 text-sm md:flex-grow pb-4 md:pb-0 border-b md:border-b-0"><a href=/authors/jiho/#about class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">About Me</a>
<a href=/posts/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item mr-4">Posts</a>
<a href=/categories/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">Categories</a></div><div class=flex><div class="relative pt-4 md:pt-0"><div class="cursor-pointer hover:text-eureka" id=lightDarkMode><i class="fas fa-adjust"></i></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open></div><div class="absolute flex flex-col left-0 md:left-auto right-auto md:right-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions><span class="px-4 py-1 hover:text-eureka">Light</span>
<span class="px-4 py-1 hover:text-eureka">Dark</span>
<span class="px-4 py-1 hover:text-eureka">Auto</span></div></div></div></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile></div></nav><script>let element=document.getElementById('lightDarkMode');storageColorScheme==null||storageColorScheme=='Auto'?document.addEventListener('DOMContentLoaded',()=>{switchMode('Auto')}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'sun'),element.firstElementChild.classList.add('fa-sun')):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'moon'),element.firstElementChild.classList.add('fa-moon')),document.addEventListener('DOMContentLoaded',()=>{getcolorscheme(),switchBurger()})</script></div></header><main class="flex-grow pt-16"><div class=pl-scrollbar><div class="w-full max-w-screen-xl lg:px-4 xl:px-8 mx-auto"><div class="grid grid-cols-2 lg:grid-cols-8 gap-4 lg:pt-12"><div class="col-span-2 lg:col-span-6 bg-secondary-bg rounded px-6 py-8"><h1 class="font-bold text-3xl text-primary-text">Slf4j Mapped Diagnostic Context (MDC) 를 이용한 사용자 요청 추적</h1><div class="flex flex-wrap flex-row items-center mt-2 text-tertiary-text"><div class="mr-6 my-2"><i class="fas fa-calendar mr-1"></i><span>2020-02-22</span></div><div class="mr-6 my-2"><i class="fas fa-clock mr-1"></i><span></span></div><div class="mr-6 my-2"><i class="fas fa-folder mr-1"></i><a href=/categories/%EA%B0%9C%EB%B0%9C/ class=hover:text-eureka>개발</a></div><div class="mr-6 my-2"><i class="fas fa-th-list mr-1"></i><a href=/series/2020/ class=hover:text-eureka>2020</a></div></div><div class=content><h2 id=문제점>문제점</h2><p>특정 에러 로그를 봤을떄 에러의 시작점을 찾기까지 추적하는데 불편함을 느낌</p><h2 id=개선-아이디어>개선 아이디어</h2><p>사용자의 요청 마다 Unique ID 를 발급하여 로그를 남길때 마다 추가
로그에 찍힌 ID를 가지고 역추적을 하여 빠르게 에러의 시작점을 파악</p><h2 id=slf4j-mapped-diagnostic-context-mdc>Slf4j Mapped Diagnostic Context (MDC)</h2><p>Thread Local에 로그 관련 정보를 남길수 있는 방법으로
put, get, remove, clear 등등의 interface를 제공한다</p><p>%X{mdcKey} 를 통해서 Pattern 에 추가할 수 있다. (<a href=http://logback.qos.ch/manual/mdc.html>logback mdc manual</a>)</p><pre><code>&lt;encoder class=&quot;ch.qos.logback.core.encoder.LayoutWrappingEncoder&quot;&gt;
    &lt;layout class=&quot;ch.qos.logback.classic.PatternLayout&quot;&gt;
        &lt;Pattern&gt;%d{yyyy-MM-dd HH:mm:ss} [%-5level] \(%F:%L\) [%X{id}] %message%n&lt;/Pattern&gt;
    &lt;/layout&gt;
&lt;/encoder&gt;
</code></pre><h2 id=spring-boot에-설정>Spring Boot에 설정</h2><p><em>Filter</em> or Interceptor 를 이용해서 처리</p><p>Unique Id 를 생성해서 세팅하는 Filter 생성</p><pre><code>public class LogbackMDCFilter implements Filter {
    private static final String ID = &quot;id&quot;;
    private static final String ID_HEADER = &quot;x-u-id&quot;;

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        try {
            setUniqueId(servletRequest, servletResponse);
        } catch (Exception e) {
            // ignore exception
        }
        try {
            filterChain.doFilter(servletRequest, servletResponse);
        } finally {
            MDC.remove(ID);
        }
    }

    private void setUniqueId(ServletRequest servletRequest, ServletResponse servletResponse) {
        HttpServletRequest httpRequest = (HttpServletRequest) servletRequest;
        HttpServletResponse httpResponse = (HttpServletResponse) servletResponse;
        // request header에 id 값이 세팅되어 있으면 그 값으로 세팅
        String uniqueId = httpRequest.getHeader(ID_HEADER);

        if (StringUtils.isEmpty(uniqueId)) {
            uniqueId = UUID.randomUUID();
        } 

        // MDC 설정
        MDC.put(ID, uniqueId);
        // Webserver logging 을 위한 Response Header 세팅
        httpResponse.addHeader(ID_HEADER, uniqueId);
    }
}
</code></pre><p>Filter 등록</p><pre><code>	@Bean
	public FilterRegistrationBean&lt;LogbackMDCFilter&gt; logbackFilter() {
		FilterRegistrationBean&lt;LogbackMDCFilter&gt; registrationBean = new FilterRegistrationBean&lt;&gt;();
		LogbackMDCFilter logbackMDCFilter = new LogbackMDCFilter();
		registrationBean.setFilter(logbackMDCFilter);
		registrationBean.addUrlPatterns(&quot;*&quot;);
		return registrationBean;
	}
</code></pre><p>코드를 보면 request header에 id 값이 있으면 해당 값을 계승하도록 구현을 하였다. 이는 MSA 환경에서 여러 서비스간 로깅 규약을 맞췄다고 했을때 여러 요청들을 하나의 컨텍스트로 묶기 위함이다.</p><h2 id=resttemplate-사용시-자동으로-header에-unique-id-값을-세팅해서-넘기게-처리>RestTemplate 사용시 자동으로 Header에 Unique ID 값을 세팅해서 넘기게 처리</h2><p>위에서도 설명했지만 MSA 환경에서 다른 서비스를 호출할때 발급한 Unique Id 값을 유지하게 되면 요청 발생 위치 추적도 용이하고 여러 로그를 ES 등을 통해서 묶어서 볼수도 있다. 그렇기에 API Call에 사용되는 RestTemplate 의 interceptors 기능을 이용해서 Unique Id를 계승 시키도록 한다.</p><pre><code>    @Bean
	public RestTemplate apiRestTemplte() {
		var httpClientBuilder = HttpClientBuilder.create().useSystemProperties();
		var clientHttpRequestFactory = new HttpComponentsClientHttpRequestFactory(httpClientBuilder.build());
		var restTemplate = new RestTemplate(clientHttpRequestFactory);
		List&lt;ClientHttpRequestInterceptor&gt; interceptors = restTemplate.getInterceptors();
		if (CollectionUtils.isEmpty(interceptors)) {
			interceptors = new ArrayList&lt;&gt;();
		}
		// Unique Id를 Header 에 넣어서 relay 처리
		interceptors.add(
			(request, body, execution) -&gt; {
				HttpHeaders headers = request.getHeaders();
				String uniqueId = MDC.get(&quot;id&quot;);
				if (StringUtils.isNotEmpty(uniqueId) &amp;&amp;
					!headers.containsKey(&quot;x-u-id&quot;)) {
					headers.set(&quot;x-u-id&quot;, uniqueId);
				}
				return execution.execute(request, body);
			}
		);
		restTemplate.setInterceptors(interceptors);
		return restTemplate;
	}
</code></pre><h2 id=rabbitmq-사용시-자동으로-unique-id-값-세팅>rabbitMq 사용시 자동으로 Unique ID 값 세팅</h2><p>MSA 환경에서 Http call 이외에도 Message queue 를 이용한도 할때 이또한 Unique Id가 자동으로 계승 될수 있도록 설정을 할수 있다.</p><p>rabbitTemplate을 이용한 전송 발생시 Unique Id 세팅</p><pre><code>	@Bean
	public RabbitTemplate rabbitTemplate() {
		RabbitTemplate template = new RabbitTemplate(connectionFactory());
		template.setBeforePublishPostProcessors(message -&gt; {
			// rabbitMQ로 요청할때 Unique Id 세팅해서 넘겨줌
			String uniqueId = MDC.get(&quot;id&quot;);
			if (StringUtils.isNotEmpty(uniqueId)) {
				message.getMessageProperties().setHeader(&quot;id&quot;, uniqueId);
			}
			return message;
		});
		return template;
	}
</code></pre><p>rabbit Listener에 Advice 설정할 클래스 생성</p><pre><code>import org.aopalliance.intercept.MethodInterceptor;
import org.aopalliance.intercept.MethodInvocation;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.MDC;
import org.springframework.amqp.core.Message;

public class LogbackMDCRabbitAdvice implements MethodInterceptor {
    private static final String ID = &quot;id&quot;;

    @Override
    public Object invoke(MethodInvocation methodInvocation) throws Throwable {
        try {
            setUniqueId(servletRequest, servletResponse);
        } catch (Exception e) {
            // ignore exception
        }

        try {
            return methodInvocation.proceed();
        } finally {
            MDC.remove(ID);
        }
    }
    private void setUniqueId(MethodInvocation methodInvocation) {
        Object[] arguments = methodInvocation.getArguments();

        Message message = (Message) arguments[1];
        String uniqueId =(String) message.getMessageProperties().getHeaders().get(ID);
        if (StringUtils.isEmpty(uniqueId)) {
            uniqueId = UUID.randomUUID();
            message.getMessageProperties().setHeader(ID, uniqueId);
        }
        MDC.put(ID, uniqueId);
    }
}
</code></pre><p>Rabbit Listener에 Advice 설정</p><pre><code>	@Bean
	public SimpleRabbitListenerContainerFactory rabbitFactory(ConnectionFactory connectionFactory
		, LogbackMDCRabbitAdvice logbackMDCRabbitAdvice) {
		SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory();
		factory.setAdviceChain(logbackMDCRabbitAdvice);
		return factory;
	}

	@Bean
	public LogbackMDCRabbitAdvice logbackMDCRabbitAdvice() {
		return new LogbackMDCRabbitAdvice();
	}
</code></pre></div><div class=my-4><a href=/tags/mdc/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#mdc</a></div><div class="flex md:justify-end my-4"><a href=https://github.com/4ppl3Hun73r/blob/master/content/posts/2020/02/slf4jMDCLogging.md title="Edit this page"><i class="fas fa-edit mr-1"></i><span></span></a></div><div class=py-2><div class="flex flex-col md:flex-row items-center my-8"><a href=/authors/jiho/ class="w-24 h-24 md:mr-4"><img src=/images/jiho.png class="w-full bg-primary-bg rounded-full" alt=Avatar></a><div class="w-full md:w-auto mt-4 md:mt-0"><a href=/authors/jiho/ class="block font-bold text-lg pb-1 mb-2 border-b">Jiho</a>
<span class="block pb-2">재미있게 개발하자!</span>
<a href=https://github.com/4ppl3Hun73r class=mr-1><i class="fab fa-github"></i></a><a href=mailto:slayer1000@gmail.com class=mr-1><i class="fas fa-envelope"></i></a><a href=https://www.linkedin.com/in/jiho-sung-159a2075 class=mr-1><i class="fab fa-linkedin"></i></a><a href=/index.xml class=mr-1><i class="fas fa-rss"></i></a></div></div></div><div class="flex flex-col md:flex-row md:justify-between -mx-2 mt-4 px-2 pt-4 border-t"><div><span class="block font-bold"></span><a href=/posts/2020/03/nginxresourcelogdisable/ class=block>nginx resource logging disable 처리</a></div><div class="md:text-right mt-4 md:mt-0"><span class="block font-bold"></span><a href=/posts/2020/01/rsocket/ class=block>rSocket</a></div></div></div><div class=col-span-2><div class="bg-secondary-bg rounded p-6"><h3 class="text-lg font-semibold mb-4"></h3><div class=content><a href=/posts/2021/03/zookeeperpractice/>zookeeper 를 이용한 leader / client 구조 개발</a><br><a href=/posts/2020/05/distributedtracing/>분산 시스템 추적 시스템</a><br><a href=/posts/2020/03/nginxresourcelogdisable/>nginx resource logging disable 처리</a><br><a href=/posts/2020/02/slf4jmdclogging/>Slf4j Mapped Diagnostic Context (MDC) 를 이용한 사용자 요청 추적</a><br><a href=/posts/2020/01/rsocket/>rSocket</a><br></div></div><div class="sticky top-16 z-10 hidden lg:block px-6 py-4 bg-primary-bg"><span class="text-lg font-semibold"></span></div><div class="sticky-toc hidden lg:block px-6 pb-6"><nav id=TableOfContents><ul><li><a href=#문제점>문제점</a></li><li><a href=#개선-아이디어>개선 아이디어</a></li><li><a href=#slf4j-mapped-diagnostic-context-mdc>Slf4j Mapped Diagnostic Context (MDC)</a></li><li><a href=#spring-boot에-설정>Spring Boot에 설정</a></li><li><a href=#resttemplate-사용시-자동으로-header에-unique-id-값을-세팅해서-넘기게-처리>RestTemplate 사용시 자동으로 Header에 Unique ID 값을 세팅해서 넘기게 처리</a></li><li><a href=#rabbitmq-사용시-자동으로-unique-id-값-세팅>rabbitMq 사용시 자동으로 Unique ID 값 세팅</a></li></ul></nav></div><script>window.addEventListener('DOMContentLoaded',()=>{enableStickyToc()})</script></div></div><script>document.addEventListener('DOMContentLoaded',()=>{hljs.initHighlightingOnLoad()})</script></div></div></main><footer class=pl-scrollbar><div class="w-full max-w-screen-xl mx-auto"><div class="text-center p-6 pin-b"><p class="text-sm text-tertiary-text">&copy; 2021 <a href=4ppl3Hun73r.github.io/>지호</a> &#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p></div></div></footer></body></html>